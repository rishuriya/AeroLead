# Render.com Blueprint Configuration
# Deploys AeroLead with Web, Worker, Database, and Redis services
# See: https://render.com/docs/blueprint-spec

services:
  # ============================================
  # Web Service (Rails + Puma)
  # ============================================
  - type: web
    name: aerolead-web
    runtime: ruby
    rootDir: ./Autodialer-app
    plan: free  # Change to 'starter' or 'standard' for production
    region: oregon
    buildCommand: |
      bundle install &&
      bundle exec rails assets:precompile
    startCommand: ./bin/start-web.sh
    healthCheckPath: /health
    envVars:
      # Rails Configuration
      - key: RAILS_ENV
        value: production
      - key: RAILS_LOG_TO_STDOUT
        value: true
      - key: RAILS_SERVE_STATIC_FILES
        value: true
      - key: PORT
        value: 10000

      # Secret Keys (set in Render dashboard)
      - key: RAILS_MASTER_KEY
        sync: false
      - key: SECRET_KEY_BASE
        generateValue: true

      # Twilio Configuration (set in Render dashboard)
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false

      # AI Service Keys (set in Render dashboard)
      - key: GEMINI_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false  # Optional
      - key: ANTHROPIC_API_KEY
        sync: false  # Optional

      # Database Connection
      - key: DATABASE_URL
        fromDatabase:
          name: aerolead-db
          property: connectionString

      # Redis Connection
      - key: REDIS_URL
        fromService:
          type: redis
          name: aerolead-redis
          property: connectionString

      # Application Settings
      - key: WEB_CONCURRENCY
        value: 2
      - key: RAILS_MAX_THREADS
        value: 5
      - key: MAX_PHONE_NUMBERS_PER_BATCH
        value: 100
      - key: MAX_BULK_ARTICLES
        value: 20

  # ============================================
  # Worker Service (Sidekiq)
  # ============================================
  - type: worker
    name: aerolead-worker
    runtime: ruby
    rootDir: ./Autodialer-app
    plan: free  # Change to 'starter' for production (free tier has limited resources)
    region: oregon
    buildCommand: |
      bundle install &&
      cd lib/linkedin_scraper &&
      npm install &&
      npx puppeteer browsers install chrome &&
      cd ../..
    startCommand: bundle exec sidekiq -C config/sidekiq.yml
    envVars:
      # Rails Configuration
      - key: RAILS_ENV
        value: production
      - key: PORT
        value: 10000

      # Secret Keys
      - key: RAILS_MASTER_KEY
        sync: false
      - key: SECRET_KEY_BASE
        generateValue: true

      # AI Service Keys
      - key: GEMINI_API_KEY
        sync: false

      # LinkedIn Scraper Configuration (set in Render dashboard)
      - key: LINKEDIN_EMAIL
        sync: false
      - key: LINKEDIN_PASSWORD
        sync: false
      - key: LINKEDIN_SCRAPER_PATH
        value: lib/linkedin_scraper
      - key: NODE_COMMAND
        value: node

      # Database Connection
      - key: DATABASE_URL
        fromDatabase:
          name: aerolead-db
          property: connectionString

      # Redis Connection
      - key: REDIS_URL
        fromService:
          type: redis
          name: aerolead-redis
          property: connectionString

# ============================================
# Database Service (PostgreSQL)
# ============================================
databases:
  - name: aerolead-db
    databaseName: aerolead_production
    plan: free  # 90 days free, then $7/month
    region: oregon
    ipAllowList: []  # Empty means allow all (required for free tier)

# ============================================
# Redis Service
# ============================================
  - name: aerolead-redis
    plan: free  # 30 days free, then $10/month
    region: oregon
    maxmemoryPolicy: allkeys-lru  # Evict least recently used keys when full
    ipAllowList: []  # Empty means allow all (required for free tier)
